####### family Poverty index category #######
#############################################
table(full_df$family_pov_level, useNA = "always")
# setting those who refused and don't know to missing
full_df$family_pov_level[full_df$family_pov_level == 7] <- NA
full_df$family_pov_level[full_df$family_pov_level == 9] <- NA
full_df$family_pov_level <- as.factor(full_df$family_pov_level)
full_df$family_pov_level <- revalue(full_df$family_pov_level, c("1"="<=1.3",
"2"="1.3-1.85",
"3"=">1.85"))
table(full_df$family_pov_level, useNA = "always")
full_df$family_pov_level <- factor(full_df$family_pov_level, ordered = T)
###########################
####### PA vigorous #######
###########################
summary(full_df$PA_vigorous, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_vigorous[full_df$PA_vigorous == 7777] <- NA
full_df$PA_vigorous[full_df$PA_vigorous == 9999] <- NA
summary(full_df$PA_vigorous, useNA = "always")
###########################
####### PA moderate #######
###########################
summary(full_df$PA_moderate, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_moderate[full_df$PA_moderate == 7777] <- NA
full_df$PA_moderate[full_df$PA_moderate == 9999] <- NA
summary(full_df$PA_moderate, useNA = "always")
############################
####### PA sedentary #######
############################
summary(full_df$PA_sedentary, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_sedentary[full_df$PA_sedentary == 7777] <- NA
full_df$PA_sedentary[full_df$PA_sedentary == 9999] <- NA
summary(full_df$PA_sedentary, useNA = "always")
#################################
####### PA transportation #######
#################################
summary(full_df$PA_transportation, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_transportation[full_df$PA_transportation == 7777] <- NA
full_df$PA_transportation[full_df$PA_transportation == 9999] <- NA
summary(full_df$PA_transportation, useNA = "always")
##############################
####### household size #######
##############################
full_df$household_size <- NULL
####################################################
####### family Poverty to Income Ratio (PIR) #######
####################################################
full_df$family_PIR <- NULL
####################################
####### family Poverty index #######
####################################
full_df$family_pov_index <- NULL
###################
####### BMI #######
###################
summary(full_df$BMI)
View(full_df)
#################################
####### PA transportation #######
#################################
full_df$PA_transportation <- NULL
full_df$DPQ010[full_df$DPQ010 == 7] <- NA
full_df$DPQ010[full_df$DPQ010 == 9] <- NA
full_df$DPQ020[full_df$DPQ020 == 7] <- NA
full_df$DPQ020[full_df$DPQ020 == 9] <- NA
full_df$DPQ030[full_df$DPQ030 == 7] <- NA
full_df$DPQ030[full_df$DPQ030 == 9] <- NA
full_df$DPQ040[full_df$DPQ040 == 7] <- NA
full_df$DPQ040[full_df$DPQ040 == 9] <- NA
full_df$DPQ050[full_df$DPQ050 == 7] <- NA
full_df$DPQ050[full_df$DPQ050 == 9] <- NA
full_df$DPQ060[full_df$DPQ060 == 7] <- NA
full_df$DPQ060[full_df$DPQ060 == 9] <- NA
full_df$DPQ070[full_df$DPQ070 == 7] <- NA
full_df$DPQ070[full_df$DPQ070 == 9] <- NA
full_df$DPQ080[full_df$DPQ080 == 7] <- NA
full_df$DPQ080[full_df$DPQ080 == 9] <- NA
full_df$DPQ090[full_df$DPQ090 == 7] <- NA
full_df$DPQ090[full_df$DPQ090 == 9] <- NA
full_df$DPQ010
table(full_df$DPQ010)
factor(full_df$DPQ010, ordered = T)
full_df$DPQ010  <- factor(full_df$DPQ010, ordered = T)
table(full_df$DPQ010)
is.factor(full_df$DPQ010)
# Set working directory
setwd("~/GitHub/NHANES_depression/Data")
# load necessary libraries
library(plyr)
library(dplyr)
library(foreign)
# load data
full_df <- readRDS("full_df.rds")
#################
##### SEQN ######
#################
# serial number, nothing to change
##########################
##### survey_weight ######
##########################
# survey weight for each 2 year data batch
# for 1999-2000 and 2001-2002, it is ALSO 2 year data weight, NOT the 4 year weight
# if data is actually merged, weights need to be recalculated
# but if we are analyzing per batch, weights are ready to be used
summary(full_df$survey_weight)
# removal of all individuals with NA as weight
full_df <- full_df[!is.na(full_df$survey_weight),]
summary(full_df$survey_weight)
sum(full_df$survey_weight == 0)
full_df <- full_df[full_df$survey_weight != 0,]
######################
##### survey_nr ######
######################
# survey number, refers to data collection batch
# 4 = 2005_2006
# 5 = 2007_2008
# 6 = 2009_2010
# 7 = 2011_2012
# 8 = 2013_2014
# 9 = 2015_2016
# 10 = 2017_2018
table(full_df$survey_nr, useNA = "always")
full_df$survey_nr <- as.factor(full_df$survey_nr)
full_df$survey_nr <- revalue(full_df$survey_nr, c("4"="2005_2006",
"5"="2007_2008",
"6"="2009_2010",
"7"="2011_2012",
"8"="2013_2014",
"9"="2015_2016",
"10"="2017_2018"))
table(full_df$survey_nr, useNA = "always")
###################
##### gender ######
###################
# survey weight for each 2 year data batch
# 1 = male
# 2 = female
table(full_df$gender, useNA = "always")
full_df$gender <- as.factor(full_df$gender)
full_df$gender <- revalue(full_df$gender, c("1"="male", "2"="female"))
table(full_df$gender, useNA = "always")
################
##### age ######
################
# numeric variable, measurement unit: yrs
summary(full_df$age)
######################
##### ethnicity ######
######################
# factor variable, coded as:
# 1 = Mexican American
# 2 = Other Hispanic
# 3 = Non-Hispanic White
# 4 = Non-Hispanic Black
# 5 = Other Race - Including Multi-Racial
table(full_df$ethnicity, useNA = "always")
# create hispanic category by merging 1 and 2
full_df$ethnicity[full_df$ethnicity == 2] <- 1
full_df$ethnicity[full_df$ethnicity == 3] <- 2
full_df$ethnicity[full_df$ethnicity == 4] <- 3
full_df$ethnicity[full_df$ethnicity == 5] <- 4
full_df$ethnicity <- as.factor(full_df$ethnicity)
full_df$ethnicity <- revalue(full_df$ethnicity, c("1"="Hispanic",
"2"="White",
"3"="Black",
"4"="Other"))
table(full_df$ethnicity, useNA = "always")
######################
##### education ######
######################
# factor variable, coded as:
# 1 = Less Than 9th Grade
# 2 = 9-11th Grade (Includes 12th grade with no diploma)
# 3 = High School Grad/GED or Equivalent
# 4 = Some College or AA degree
# 5 = College Graduate or above
# 7 = Refused
# 9 = Don't Know
# note - there are no level 6 and level 8 (not a mistake)
table(full_df$education, useNA = "always")
# setting those who refused and don't know to missing
full_df$education[full_df$education == 7] <- NA
full_df$education[full_df$education == 9] <- NA
full_df$education <- as.factor(full_df$education)
full_df$education <- revalue(full_df$education, c("1"="<9 grade",
"2"="9-11 grade",
"3"="GED",
"4"="some college",
"5"="college"))
full_df$education <- factor(full_df$education, ordered = T)
table(full_df$education, useNA = "always")
########################################
####### education in <19 yrs old #######
########################################
full_df$education_young <- NULL
######################
####### income #######
######################
table(full_df$ann_household_income, useNA = "always")
# setting those who refused and don't know to missing
full_df$ann_household_income[full_df$ann_household_income == 77] <- NA
full_df$ann_household_income[full_df$ann_household_income == 99] <- NA
full_df$ann_household_income <- as.factor(full_df$ann_household_income)
full_df$ann_household_income <- revalue(full_df$ann_household_income, c("1"="0-4,999",
"2"="5,000-9,999",
"3"="10,000-14,999",
"4"="15,000-19,999",
"5"="20,000-24,999",
"6"="25,000-34,999",
"7"="35,000-44,999",
"8"="45,000-54,999",
"9"="55,000-64,999",
"10"="65,000-74,999",
"11"="75,000 and over",
"12"="20,000 and over",
"13"="Under 20,000",
"14"="75,000-99,999",
"15"="100,000 and over"))
table(full_df$ann_household_income, useNA = "always")
full_df$ann_household_income <- factor(full_df$ann_household_income, ordered = T)
#######################
##### occupation ######
#######################
full_df$work_status <- NULL
###########################
##### work situation ######
###########################
full_df$work_situation <- NULL
###################################
##### reason for not working ######
###################################
full_df$reason_not_working <- NULL
###########################
##### marital status ######
###########################
table(full_df$marital, useNA = "always")
# setting those who refused and don't know to missing
full_df$marital[full_df$marital == 77] <- NA
full_df$marital[full_df$marital == 99] <- NA
full_df$marital <- as.factor(full_df$marital)
full_df$marital <- revalue(full_df$marital, c("1"="Married",
"2"="Widowed",
"3"="Divorced",
"4"="Separated",
"5"="Never married",
"6"="Living with partner"))
table(full_df$marital, useNA = "always")
###########################
####### citizenship #######
###########################
full_df$citizen <- NULL
######################
####### asthma #######
######################
table(full_df$asthma, useNA = "always")
# setting those who refused and don't know to missing
full_df$asthma[full_df$asthma == 7] <- NA
full_df$asthma[full_df$asthma == 9] <- NA
full_df$asthma <- as.factor(full_df$asthma)
full_df$asthma <- revalue(full_df$asthma, c("1"="Yes",
"2"="No"))
table(full_df$asthma, useNA = "always")
#########################
####### arthritis #######
#########################
table(full_df$arthritis, useNA = "always")
# setting those who refused and don't know to missing
full_df$arthritis[full_df$arthritis == 7] <- NA
full_df$arthritis[full_df$arthritis == 9] <- NA
full_df$arthritis <- as.factor(full_df$arthritis)
full_df$arthritis <- revalue(full_df$arthritis, c("1"="Yes",
"2"="No"))
table(full_df$arthritis, useNA = "always")
########################
######## angina ########
########################
table(full_df$angina, useNA = "always")
# setting those who refused and don't know to missing
full_df$angina[full_df$angina == 7] <- NA
full_df$angina[full_df$angina == 9] <- NA
full_df$angina <- as.factor(full_df$angina)
full_df$angina <- revalue(full_df$angina, c("1"="Yes",
"2"="No"))
table(full_df$angina, useNA = "always")
########################
######## stroke ########
########################
table(full_df$stroke, useNA = "always")
# setting those who refused and don't know to missing
full_df$stroke[full_df$stroke == 7] <- NA
full_df$stroke[full_df$stroke == 9] <- NA
full_df$stroke <- as.factor(full_df$stroke)
full_df$stroke <- revalue(full_df$stroke, c("1"="Yes",
"2"="No"))
table(full_df$stroke, useNA = "always")
##########################
######## diabetes ########
##########################
table(full_df$diabetes, useNA = "always")
# setting those who refused and don't know to missing
full_df$diabetes[full_df$diabetes == 7] <- NA
full_df$diabetes[full_df$diabetes == 9] <- NA
full_df$diabetes <- as.factor(full_df$diabetes)
full_df$diabetes <- revalue(full_df$diabetes, c("1"="Yes",
"2"="No",
"3"="Borderline"))
table(full_df$diabetes, useNA = "always")
##############################
######## hypertension ########
##############################
table(full_df$hypertension, useNA = "always")
# setting those who refused and don't know to missing
full_df$hypertension[full_df$hypertension == 7] <- NA
full_df$hypertension[full_df$hypertension == 9] <- NA
full_df$hypertension <- as.factor(full_df$hypertension)
full_df$hypertension <- revalue(full_df$hypertension, c("1"="Yes",
"2"="No"))
table(full_df$hypertension, useNA = "always")
#########################
######## smoking ########
#########################
table(full_df$smoking_ever, useNA = "always")
# setting those who refused and don't know to missing
full_df$smoking_ever[full_df$smoking_ever == 7] <- NA
full_df$smoking_ever[full_df$smoking_ever == 9] <- NA
table(full_df$smoking_now, useNA = "always")
# setting those who refused and don't know to missing
full_df$smoking_now[full_df$smoking_now == 7] <- NA
full_df$smoking_now[full_df$smoking_now == 9] <- NA
# create new variable called smoking
# 1 = never smoked
# 2 = ex smoker
# 3 = sometimes smoker
# 4 = current smoker
full_df$smoking <- NA
full_df$smoking[full_df$smoking_ever == 2] <- 1
full_df$smoking[full_df$smoking_now == 3] <- 2
full_df$smoking[full_df$smoking_now == 2] <- 3
full_df$smoking[full_df$smoking_now == 1] <- 4
table(full_df$smoking, useNA = "always")
full_df$smoking <- as.factor(full_df$smoking)
full_df$smoking <- revalue(full_df$smoking, c("1"="never-smoker",
"2"="ex-smoker",
"3"="sometimes-smoker",
"4"="current-smoker"))
table(full_df$smoking, useNA = "always")
full_df$smoking_ever <- NULL
full_df$smoking_now <- NULL
#########################
######## alcohol ########
#########################
table(full_df$alcohol_ever, useNA = "always")
# setting those who refused and don't know to missing
full_df$alcohol_ever[full_df$alcohol_ever == 7] <- NA
full_df$alcohol_ever[full_df$alcohol_ever == 9] <- NA
table(full_df$alcohol_quantity, useNA = "always")
# setting those who refused and don't know to missing
full_df$alcohol_quantity[full_df$alcohol_quantity == 777] <- NA
full_df$alcohol_quantity[full_df$alcohol_quantity == 999] <- NA
# create new variable called alcohol
# 1 = never drinker
# 2 = light drinker
# 3 = heavy drinker
full_df$alcohol <- NA
full_df$alcohol[full_df$alcohol_ever == 2] <- 1
full_df$alcohol[full_df$alcohol_quantity < 4 & full_df$gender == "female"] <- 2
full_df$alcohol[full_df$alcohol_quantity < 5 & full_df$gender == "male"] <- 2
full_df$alcohol[full_df$alcohol_quantity >=4 & full_df$gender == "female"] <- 3
full_df$alcohol[full_df$alcohol_quantity >=5 & full_df$gender == "male"] <- 3
table(full_df$alcohol, useNA = "always")
full_df$alcohol <- as.factor(full_df$alcohol)
full_df$alcohol <- revalue(full_df$alcohol, c("1"="never-drinker",
"2"="light-drinker",
"3"="heavy-drinker"))
table(full_df$alcohol, useNA = "always")
full_df$alcohol_ever <- NULL
full_df$alcohol_quantity <- NULL
#############################################
####### family Poverty index category #######
#############################################
table(full_df$family_pov_level, useNA = "always")
# setting those who refused and don't know to missing
full_df$family_pov_level[full_df$family_pov_level == 7] <- NA
full_df$family_pov_level[full_df$family_pov_level == 9] <- NA
full_df$family_pov_level <- as.factor(full_df$family_pov_level)
full_df$family_pov_level <- revalue(full_df$family_pov_level, c("1"="<=1.3",
"2"="1.3-1.85",
"3"=">1.85"))
table(full_df$family_pov_level, useNA = "always")
full_df$family_pov_level <- factor(full_df$family_pov_level, ordered = T)
###########################
####### PA vigorous #######
###########################
summary(full_df$PA_vigorous, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_vigorous[full_df$PA_vigorous == 7777] <- NA
full_df$PA_vigorous[full_df$PA_vigorous == 9999] <- NA
summary(full_df$PA_vigorous, useNA = "always")
###########################
####### PA moderate #######
###########################
summary(full_df$PA_moderate, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_moderate[full_df$PA_moderate == 7777] <- NA
full_df$PA_moderate[full_df$PA_moderate == 9999] <- NA
summary(full_df$PA_moderate, useNA = "always")
############################
####### PA sedentary #######
############################
summary(full_df$PA_sedentary, useNA = "always")
# setting those who refused and don't know to missing
full_df$PA_sedentary[full_df$PA_sedentary == 7777] <- NA
full_df$PA_sedentary[full_df$PA_sedentary == 9999] <- NA
summary(full_df$PA_sedentary, useNA = "always")
#################################
####### PA transportation #######
#################################
full_df$PA_transportation <- NULL
##############################
####### household size #######
##############################
full_df$household_size <- NULL
####################################################
####### family Poverty to Income Ratio (PIR) #######
####################################################
full_df$family_PIR <- NULL
####################################
####### family Poverty index #######
####################################
full_df$family_pov_index <- NULL
###################
####### BMI #######
###################
summary(full_df$BMI)
#########################
#### PHQ9 answers ######
#########################
# 0 = No
# 1 = Yes
full_df$DPQ010[full_df$DPQ010 == 7] <- NA
full_df$DPQ010[full_df$DPQ010 == 9] <- NA
full_df$DPQ020[full_df$DPQ020 == 7] <- NA
full_df$DPQ020[full_df$DPQ020 == 9] <- NA
full_df$DPQ030[full_df$DPQ030 == 7] <- NA
full_df$DPQ030[full_df$DPQ030 == 9] <- NA
full_df$DPQ040[full_df$DPQ040 == 7] <- NA
full_df$DPQ040[full_df$DPQ040 == 9] <- NA
full_df$DPQ050[full_df$DPQ050 == 7] <- NA
full_df$DPQ050[full_df$DPQ050 == 9] <- NA
full_df$DPQ060[full_df$DPQ060 == 7] <- NA
full_df$DPQ060[full_df$DPQ060 == 9] <- NA
full_df$DPQ070[full_df$DPQ070 == 7] <- NA
full_df$DPQ070[full_df$DPQ070 == 9] <- NA
full_df$DPQ080[full_df$DPQ080 == 7] <- NA
full_df$DPQ080[full_df$DPQ080 == 9] <- NA
full_df$DPQ090[full_df$DPQ090 == 7] <- NA
full_df$DPQ090[full_df$DPQ090 == 9] <- NA
full_df$phq <- ifelse(full_df$DPQ010<=3 | full_df$DPQ020<=3 | full_df$DPQ030<=3
| full_df$DPQ040<=3 | full_df$DPQ050<=3 | full_df$DPQ060<=3
| full_df$DPQ070<=3 | full_df$DPQ080<=3 | full_df$DPQ090<=3, 1, 0)
full_df$phq[is.na(full_df$phq)] <- 0
full_df$phq
table(full_df$phq, useNA = "always")
table(full_df$phq, useNA = "always")
View(full_df)
full_df$DPQ010  <- factor(full_df$DPQ010, ordered = T)
full_df$DPQ020  <- factor(full_df$DPQ020, ordered = T)
full_df$DPQ030  <- factor(full_df$DPQ030, ordered = T)
full_df$DPQ040  <- factor(full_df$DPQ040, ordered = T)
full_df$DPQ050  <- factor(full_df$DPQ050, ordered = T)
full_df$DPQ060  <- factor(full_df$DPQ060, ordered = T)
full_df$DPQ070  <- factor(full_df$DPQ070, ordered = T)
full_df$DPQ080  <- factor(full_df$DPQ080, ordered = T)
full_df$DPQ090  <- factor(full_df$DPQ090, ordered = T)
View(full_df)
# SAVE DATA PER SURVEY
for (i in levels(full_df$survey_nr)) {
filename <- paste0("full_",i,".rds")
survey_df <- full_df[full_df$survey_nr == i,]
saveRDS(survey_df, filename)
}
# RECALCULATING WEIGHTS FOR THE MERGED DATA
n_surveys <- length(unique(full_df$survey_nr))
full_df$survey_weight <- full_df$survey_weight/n_surveys
# SAVE FULL FINAL DATASET
saveRDS(full_df, "cleaned_full_df.rds")
# Set working directory
setwd("~/GitHub/NHANES_depression/Data")
# load necessary libraries
library(mice)
library(foreign)
# load complete merged data to obtain survey number levels
# nothing to do with this data, we only need the factor levels for the loop
cleaned_full_df <- readRDS("cleaned_full_df.rds")
# calculate average missingness in data
(sum(is.na(cleaned_full_df[cleaned_full_df$phq == "Yes",]))/prod(dim(cleaned_full_df[cleaned_full_df$phq == "Yes",])))*100
# it is 13.8%, we will impute 15 copies
full_df <- cleaned_full_df
# MICE IMPUTATION
# save variables as vectors that are not needed for imputation
SEQN <- full_df$SEQN
full_df$SEQN <- NULL
SDMVPSU <- full_df$SDMVPSU
full_df$SDMVPSU <- NULL
SDMVSTRA <- full_df$SDMVSTRA
full_df$SDMVSTRA <- NULL
# imputation: 1 copy, 5 iterations, predictive mean matching algorithm
imputation_object <- mice(full_df, method = "rf", m = 15, maxit = 5, seed = 35670)
